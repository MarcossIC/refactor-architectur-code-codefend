import React, { useMemo } from 'react';
import { Doughnut } from 'react-chartjs-2';
import { EmptyCard, PageLoader, BugIcon, Table, Show, SimpleSection } from '..';
import {
	IssuesShare,
	generateIDArray,
	isEmptyData,
	useDoughnutChart,
	MetricsService,
	ChartValueType,
} from '../../../data';

interface VulnerabilityRiskProps {
	vulnerabilityByRisk: IssuesShare;
	isLoading: boolean;
}

export const VulnerabilityRisk: React.FC<VulnerabilityRiskProps> = ({
	vulnerabilityByRisk,
	isLoading,
}) => {
	const { chartData, otherMetrics, total, chartOptions } = useDoughnutChart({
		data: vulnerabilityByRisk,
		type: ChartValueType.PLAIN,
	});

	const dataEmptyState = useMemo(() => {
		const { total, ...otherMetrics } = vulnerabilityByRisk;
		return isEmptyData(otherMetrics);
	}, [vulnerabilityByRisk]);

	const { renderPercentage } = MetricsService;

	const tableColumns = useMemo(() => ['risk', 'count', 'percent'], []);

	const tableRows = useMemo(() => {
		return Object.keys(otherMetrics).map((metric: string | number) => {
			return {
				risk: metric,
				count: otherMetrics[metric as keyof typeof otherMetrics],
				percent: renderPercentage(
					String(otherMetrics[metric as keyof typeof otherMetrics]),
					String(total),
				),
			};
		});
	}, [otherMetrics]);

	return (
		<div className="card risk-chart">
			<Show when={!isLoading} fallback={<PageLoader />}>
				<>
					<SimpleSection
						header="Vulnerabilities by risk"
						icon={<BugIcon />}>
						<div className="content">
							<Show when={!dataEmptyState} fallback={<EmptyCard />}>
								<>
									<div className="chart">
										<Doughnut
											data={chartData}
											options={chartOptions}
										/>
									</div>

									<Table columns={tableColumns} data={tableRows} />
								</>
							</Show>
						</div>
					</SimpleSection>
				</>
			</Show>
		</div>
	);
};
